name: Autograding Tests - Formatif F2
on:
  - push
  - workflow_dispatch
  - repository_dispatch
permissions:
  checks: write
  actions: read
  contents: read
jobs:
  run-autograding-tests:
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # RÃ©cupÃ©rer tout l'historique pour vÃ©rifier les branches

      - name: VÃ©rifier les marqueurs de tests locaux
        id: check-markers
        run: |
          echo "VÃ©rification que les tests locaux ont Ã©tÃ© exÃ©cutÃ©s..."

          # VÃ©rifier que le dossier .test_markers existe
          if [ ! -d ".test_markers" ]; then
            echo "âŒ ERREUR: Les tests locaux n'ont pas Ã©tÃ© exÃ©cutÃ©s!"
            echo "Veuillez exÃ©cuter 'python3 run_tests.py' sur le Raspberry Pi avant de pousser."
            exit 1
          fi

          # VÃ©rifier les marqueurs requis
          required_markers=(
            "led_scripts_verified.txt"
            "dht22_script_verified.txt"
            "git_branches_verified.txt"
            "git_commits_verified.txt"
          )

          missing_markers=()
          for marker in "${required_markers[@]}"; do
            if [ ! -f ".test_markers/$marker" ]; then
              missing_markers+=("$marker")
            fi
          done

          if [ ${#missing_markers[@]} -gt 0 ]; then
            echo "âŒ ERREUR: Marqueurs de tests manquants:"
            for marker in "${missing_markers[@]}"; do
              echo "   - $marker"
            done
            echo "Veuillez exÃ©cuter 'python3 run_tests.py' sur le Raspberry Pi."
            exit 1
          fi

          echo "âœ… Tous les marqueurs de tests sont prÃ©sents"

      - name: VÃ©rifier la syntaxe Python - Scripts LED
        id: led-syntax
        run: |
          echo "VÃ©rification de la syntaxe Python des scripts LED..."

          # VÃ©rifier led_simple.py
          if [ -f "led_simple.py" ]; then
            python3 -m py_compile led_simple.py
            echo "âœ… led_simple.py: syntaxe valide"
          else
            echo "âŒ led_simple.py introuvable"
            exit 1
          fi

          # VÃ©rifier led_rgb.py (optionnel)
          if [ -f "led_rgb.py" ]; then
            python3 -m py_compile led_rgb.py
            echo "âœ… led_rgb.py: syntaxe valide"
          fi

      - name: VÃ©rifier les imports RPi.GPIO
        id: led-imports
        run: |
          echo "VÃ©rification des imports RPi.GPIO..."

          if grep -q "import RPi.GPIO" led_simple.py; then
            echo "âœ… Import RPi.GPIO trouvÃ© dans led_simple.py"
          else
            echo "âŒ Import RPi.GPIO manquant dans led_simple.py"
            exit 1
          fi

      - name: VÃ©rifier la syntaxe Python - Script DHT22
        id: dht22-syntax
        run: |
          echo "VÃ©rification de la syntaxe Python du script DHT22..."

          if [ -f "dht22.py" ]; then
            python3 -m py_compile dht22.py
            echo "âœ… dht22.py: syntaxe valide"
          else
            echo "âŒ dht22.py introuvable"
            exit 1
          fi

      - name: VÃ©rifier les imports Adafruit
        id: dht22-imports
        run: |
          echo "VÃ©rification des imports Adafruit..."

          if grep -q "import board" dht22.py && grep -q "adafruit_dht" dht22.py; then
            echo "âœ… Imports requis trouvÃ©s dans dht22.py"
          else
            echo "âŒ Imports requis manquants dans dht22.py"
            exit 1
          fi

      - name: VÃ©rifier l'historique Git - Branches
        id: git-branches
        run: |
          echo "VÃ©rification des branches Git dans l'historique..."

          # Chercher les branches feature dans l'historique
          if git log --all --oneline --grep="feature/led" | grep -q . || \
             git log --all --oneline --grep="led" | grep -q .; then
            echo "âœ… Branche feature/led dÃ©tectÃ©e dans l'historique"
          else
            echo "âš ï¸  Branche feature/led non dÃ©tectÃ©e (peut Ãªtre fusionnÃ©e)"
          fi

          if git log --all --oneline --grep="feature/dht22" | grep -q . || \
             git log --all --oneline --grep="dht22" | grep -q .; then
            echo "âœ… Branche feature/dht22 dÃ©tectÃ©e dans l'historique"
          else
            echo "âš ï¸  Branche feature/dht22 non dÃ©tectÃ©e (peut Ãªtre fusionnÃ©e)"
          fi

      - name: VÃ©rifier le format des commits
        id: git-commits
        run: |
          echo "VÃ©rification du format des messages de commit..."

          # Compter les commits conventionnÃ©s
          total=$(git log --oneline -20 | wc -l)
          if [ $total -gt 0 ]; then
            conventional=$(git log --oneline -20 | grep -E "^(feat|fix|docs|test|refactor|style|chore)\(" | wc -l)
            echo "Commits conventionnÃ©s: $conventional/$total"

            if [ $conventional -gt 0 ]; then
              echo "âœ… Format des commits conforme"
            else
              echo "âš ï¸  Aucun commit conventionnÃ© dÃ©tectÃ©"
            fi
          fi

      - name: Rapport de rÃ©ussite
        if: success()
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           ğŸ‰ FORMATIF F2 - RÃ‰USSI! ğŸ‰                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… Toutes les vÃ©rifications sont passÃ©es:"
          echo "   - Scripts LED crÃ©Ã©s et syntaxe valide"
          echo "   - Script DHT22 crÃ©Ã© et syntaxe valide"
          echo "   - Tests locaux exÃ©cutÃ©s sur Raspberry Pi"
          echo "   - Historique Git avec branches"

      - name: CrÃ©er le rapport de notation
        uses: classroom-resources/autograding-grading-reporter@v1
        if: always()
        with:
          runners: |
            check-markers
            led-syntax,led-imports
            dht22-syntax,dht22-imports
            git-branches,git-commits
